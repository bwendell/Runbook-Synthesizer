openapi: 3.0.3
info:
  title: Runbook-Synthesizer API
  description: |
    Dynamic SOP generation for OCI using RAG (Retrieval Augmented Generation).

    This API provides endpoints for:
    - Alert ingestion and checklist generation
    - Runbook re-indexing from OCI Object Storage
    - Webhook destination management
    - Health monitoring
  version: 1.0.0
  contact:
    name: Runbook-Synthesizer Team
  license:
    name: Oracle Proprietary

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://runbook-synthesizer.oraclecloud.com
    description: Production server

tags:
  - name: Health
    description: Health and readiness checks
  - name: Alerts
    description: Alert ingestion and checklist generation
  - name: Runbooks
    description: Runbook synchronization from Object Storage
  - name: Webhooks
    description: Webhook destination management

paths:
  /api/v1/health:
    get:
      summary: Health check
      description: Returns the health status of the application
      operationId: getHealth
      tags:
        - Health
      responses:
        "200":
          description: Application is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: UP
                timestamp: "2024-01-16T00:00:00Z"

  /api/v1/alerts:
    post:
      summary: Ingest alert and generate checklist
      description: |
        Receives an alert and generates a dynamic troubleshooting checklist
        using RAG (Retrieval Augmented Generation) from indexed runbooks.
      operationId: createAlert
      tags:
        - Alerts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AlertRequest"
            example:
              title: High CPU Usage
              message: CPU utilization is above 95%
              severity: CRITICAL
              sourceService: oci-monitoring
              dimensions:
                compartmentId: ocid1.compartment.oc1..xxx
                resourceId: ocid1.instance.oc1..xxx
              labels:
                env: production
      responses:
        "200":
          description: Checklist generated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChecklistResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/webhooks:
    get:
      summary: List configured webhooks
      description: Returns all configured webhook destinations
      operationId: listWebhooks
      tags:
        - Webhooks
      responses:
        "200":
          description: List of webhook configurations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/WebhookConfig"

    post:
      summary: Register a new webhook
      description: Adds a new webhook destination for checklist notifications
      operationId: createWebhook
      tags:
        - Webhooks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebhookConfig"
            example:
              name: slack-production
              type: SLACK
              url: https://hooks.slack.com/services/xxx
              enabled: true
              filterSeverities:
                - CRITICAL
                - WARNING
      responses:
        "201":
          description: Webhook created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookConfig"
        "400":
          description: Invalid webhook configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/runbooks/sync:
    post:
      summary: Trigger runbook synchronization
      description: |
        Triggers re-indexing of runbooks from OCI Object Storage.
        Returns immediately with a tracking ID; processing happens asynchronously.
      operationId: syncRunbooks
      tags:
        - Runbooks
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SyncRequest"
            example:
              bucketName: my-runbooks
              prefix: ops/
              forceRefresh: true
      responses:
        "202":
          description: Sync started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SyncResponse"
              example:
                status: STARTED
                documentsProcessed: 0
                errors: []
                requestId: 550e8400-e29b-41d4-a716-446655440000

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [UP, DOWN]
          description: Health status
        timestamp:
          type: string
          format: date-time
          description: When the health check was performed
      required:
        - status
        - timestamp

    AlertRequest:
      type: object
      properties:
        title:
          type: string
          description: The alert title/name
        message:
          type: string
          description: The detailed alert message
        severity:
          type: string
          enum: [CRITICAL, WARNING, INFO]
          description: The severity level of the alert
        sourceService:
          type: string
          description: The originating service (e.g., oci-monitoring)
        dimensions:
          type: object
          additionalProperties:
            type: string
          description: Key-value pairs from the alert source
        labels:
          type: object
          additionalProperties:
            type: string
          description: Custom labels/tags
        rawPayload:
          type: string
          description: The original JSON payload for debugging
      required:
        - title
        - severity

    ChecklistResponse:
      type: object
      properties:
        alertId:
          type: string
          description: The ID of the triggering alert
        summary:
          type: string
          description: High-level summary of the checklist
        steps:
          type: array
          items:
            $ref: "#/components/schemas/ChecklistStep"
        sourceRunbooks:
          type: array
          items:
            type: string
          description: Paths to runbooks that contributed
        generatedAt:
          type: string
          format: date-time
        llmProviderUsed:
          type: string
          description: Which LLM provider was used
      required:
        - alertId
        - steps
        - generatedAt

    ChecklistStep:
      type: object
      properties:
        order:
          type: integer
          description: Step number for ordering
        instruction:
          type: string
          description: The actionable instruction
        rationale:
          type: string
          description: Why this step matters
        currentValue:
          type: string
          description: Current observed value
        expectedValue:
          type: string
          description: Expected/healthy value
        priority:
          type: string
          enum: [HIGH, MEDIUM, LOW]
        commands:
          type: array
          items:
            type: string
          description: Executable commands to run
      required:
        - order
        - instruction

    WebhookConfig:
      type: object
      properties:
        name:
          type: string
          description: Unique name for this webhook
        type:
          type: string
          enum: [SLACK, PAGERDUTY, GENERIC]
          description: The webhook type
        url:
          type: string
          format: uri
          description: The webhook URL
        enabled:
          type: boolean
          description: Whether this webhook is active
        filterSeverities:
          type: array
          items:
            type: string
          description: Only send alerts with these severities
        headers:
          type: object
          additionalProperties:
            type: string
          description: Custom HTTP headers
      required:
        - name
        - url

    SyncRequest:
      type: object
      properties:
        bucketName:
          type: string
          description: Optional bucket name to sync from
        prefix:
          type: string
          description: Optional prefix to filter runbooks
        forceRefresh:
          type: boolean
          description: Re-index even if unchanged

    SyncResponse:
      type: object
      properties:
        status:
          type: string
          enum: [STARTED, COMPLETED, FAILED]
          description: Current sync status
        documentsProcessed:
          type: integer
          description: Number of documents processed
        errors:
          type: array
          items:
            type: string
          description: Error messages if any
        requestId:
          type: string
          format: uuid
          description: Unique ID for tracking
      required:
        - status
        - requestId

    ErrorResponse:
      type: object
      properties:
        correlationId:
          type: string
          description: Unique identifier for tracking
        errorCode:
          type: string
          description: Machine-readable error code
        message:
          type: string
          description: Human-readable error message
        timestamp:
          type: string
          format: date-time
        details:
          type: object
          additionalProperties:
            type: string
          description: Field-level validation errors
      required:
        - correlationId
        - errorCode
        - timestamp
